{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Strike Apparel</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="bg-gray-50 w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header Section -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Latest Product</h1>
      <p class="text-gray-600">Stay updated with the latest football products</p>
    </div>

    <!-- Filter Section -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
      <div class="flex flex-wrap gap-3 mb-4 sm:mb-0">

        <!-- All Product -->
        <a 
          href="?filter=all{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
          class="{% if request.GET.filter == 'all' or not request.GET.filter %} bg-[#57A0D3] text-white {% else %}bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium transition-colors hover:bg-[#57A0D3] hover:text-white">
          All Product
        </a>

        <!-- My Product -->
        <a 
          href="?filter=my{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
          class="{% if request.GET.filter == 'my' %} bg-[#57A0D3] text-white {% else %}bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium transition-colors hover:bg-[#57A0D3] hover:text-white">
          My Product
        </a>

        <!-- Category Dropdown -->
        <form method="get" class="inline-block">
          {% if request.GET.filter %}
            <input type="hidden" name="filter" value="{{ request.GET.filter }}">
          {% endif %}
          <select 
            name="category" 
            onchange="this.form.submit()" 
            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 focus:outline-none focus:ring-2 focus:ring-[#57A0D3] focus:border-[#57A0D3]">
            <option value="">All Categories</option>
            <option value="jersey" {% if request.GET.category == 'jersey' %}selected{% endif %}>Jersey</option>
            <option value="ball" {% if request.GET.category == 'ball' %}selected{% endif %}>Bola</option>
            <option value="shoes" {% if request.GET.category == 'shoes' %}selected{% endif %}>Sepatu</option>
          </select>
        </form>
      </div>

      {% if user.is_authenticated %}
        <div class="text-sm text-gray-500">
          Last login: {{ last_login }}
        </div>
      {% endif %}
    </div>

    <!-- Product Grid -->
    {% if not product_list %}
      <div class="bg-white rounded-lg border border-gray-200 p-12 text-center shadow-sm">
        <div class="w-32 h-32 mx-auto mb-4">
          <img src="{% static 'image/no-product.png' %}" alt="No product available" class="w-full h-full object-contain">
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No product found</h3>
        <p class="text-gray-500 mb-6">Be the first to add football product.</p>
        <a href="{% url 'main:create_product' %}" class="inline-flex items-center px-4 py-2 bg-[#57A0D3] text-white rounded-md hover:bg-[#57A0D3] transition-colors">
          Create Product
        </a>
      </div>
    {% else %}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for product in product_list %}
          {% include 'card_product.html' with product=product %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Modal -->
<div id="crudModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="crudModalContent" class="bg-white rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto">
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <h3 class="text-xl font-semibold text-gray-900">Create New Product</h3>
        <p class="text-sm text-gray-600 mt-1">Add your latest football merchandise</p>
      </div>
      <button type="button" class="text-gray-400 hover:text-gray-900" onclick="hideModal()">&times;</button>
    </div>
    <div class="px-6 py-4 space-y-6">
      <form id="productForm">
        {% csrf_token %}
        <div class="mb-4">
          <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
          <input type="text" id="name" name="name" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2" required>
        </div>
        <div class="mb-4">
          <label for="price" class="block text-sm font-medium text-gray-700">Price</label>
          <input type="number" id="price" name="price" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2" required>
        </div>
        <div class="mb-4">
          <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
          <textarea id="description" name="description" rows="3" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2" required></textarea>
        </div>
        <div class="mb-4">
          <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
          <select id="category" name="category" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2" required>
            <option value="">Select category</option>
            <option value="jersey">Jersey</option>
            <option value="ball">Ball</option>
            <option value="shoes">Shoes</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="thumbnail" class="block text-sm font-medium text-gray-700">Thumbnail URL</label>
          <input type="url" id="thumbnail" name="thumbnail" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2">
        </div>
        <div class="flex items-center mb-4">
          <input id="is_featured" name="is_featured" type="checkbox" class="w-4 h-4 text-[#57A0D3] border-gray-300 rounded">
          <label for="is_featured" class="ml-2 text-sm font-medium text-gray-900">Featured</label>
        </div>
        <div class="flex justify-end gap-3 border-t pt-4">
          <button type="button" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-50" onclick="hideModal()">Cancel</button>
          <button type="submit" class="bg-[#57A0D3] text-white px-4 py-2 rounded-md hover:bg-[#57A0D3]/90">Publish</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div class="bg-white rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto">
    <div class="p-6 text-center">
      <h3 class="text-xl font-semibold text-gray-900 mb-2">Confirm Delete</h3>
      <p class="text-gray-600 mb-6">Are you sure you want to delete this product? This action cannot be undone.</p>
      <div class="flex justify-center gap-4">
        <button onclick="hideDeleteModal()" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
        <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

<script>
// CSRF Token
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// --- Toast Function ---
function showToast(title, message, type) {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `p-4 rounded shadow ${type === 'success' ? 'bg-[#57A0D3] text-white' : 'bg-red-500 text-white'}`;
    toast.innerHTML = `<strong>${title}</strong><p>${message}</p>`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// --- Modal Control Functions ---
function showModal() {
    document.getElementById('productForm').reset();
    document.getElementById('productForm').setAttribute('data-mode', 'create');
    document.getElementById('productForm').setAttribute('data-product-id', '');
    document.querySelector('#crudModal h3').textContent = 'Create New Product';
    document.querySelector('#crudModal p.text-sm.text-gray-600').textContent = 'Add your latest football merchandise';
    document.querySelector('#productForm button[type="submit"]').textContent = 'Publish';
    document.getElementById('crudModal').classList.remove('hidden');
    document.getElementById('name').focus();
}

function hideModal() {
    document.getElementById('crudModal').classList.add('hidden');
    document.activeElement.blur();
}

// --- AJAX Form Submission ---
document.getElementById('productForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const mode = form.getAttribute('data-mode');
    const productId = form.getAttribute('data-product-id');
    const formData = new FormData(form);

    let url;
    if (mode === 'edit' && productId) {
        url = `{% url 'main:edit_product_entry_ajax' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', productId);
    } else {
        url = "{% url 'main:add_product_entry_ajax' %}";
    }

    const response = await fetch(url, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        body: formData
    });

    if (response.ok) {
        hideModal();
        const data = await response.json();

        const filter = new URLSearchParams(window.location.search).get('filter') || 'all';
        const category = new URLSearchParams(window.location.search).get('category') || '';
        fetchProducts(filter, category);

        showToast("Success!", mode === 'create' ? "Product created successfully." : "Product updated successfully.", "success");
        form.reset();
    } else {
        const errorText = await response.text();
        console.error("AJAX Error:", errorText); 
        showToast("Error", "Something went wrong. Please check your data.", "error");
    }
});

// --- Fetch Products for Grid ---
async function fetchProducts(filter, category) {
    const params = new URLSearchParams();
    if (filter) params.append("filter", filter);
    if (category) params.append("category", category);

    const response = await fetch("{% url 'main:product_list_ajax' %}?" + params.toString());
    const data = await response.text();
    document.getElementById("productGrid").innerHTML = data;
}

// --- Delete Product ---
let deleteProductId = null;
function showDeleteModal(productId) {
    deleteProductId = productId;
    document.getElementById('deleteModal').classList.remove('hidden');
}
function hideDeleteModal() {
    deleteProductId = null;
    document.getElementById('deleteModal').classList.add('hidden');
}
document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
    if (!deleteProductId) return;

    const url = `{% url 'main:delete_product_ajax' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', deleteProductId);
    const response = await fetch(url, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken}
    });

    if (response.ok) {
        showToast("Success!", "Product deleted successfully.", "success");

        // Hapus card langsung dari DOM
        const card = document.querySelector(`[data-action="edit"][data-product-id="${deleteProductId}"]`)?.closest('article');
        if (card) card.remove();

        deleteProductId = null;
    } else {
        showToast("Error", "Failed to delete product.", "error");
    }

    hideDeleteModal();
});


// --- Show Edit Modal ---
async function showEditModal(productId) {
    try {
        const url = `{% url 'main:get_product_json_ajax' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', productId);
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch product data.');
        const product = await response.json();

        document.querySelector('#crudModal h3').textContent = 'Edit Product';
        document.querySelector('#crudModal p.text-sm.text-gray-600').textContent = 'Update your football merchandise details';
        document.querySelector('#productForm button[type="submit"]').textContent = 'Update';
        document.getElementById('productForm').setAttribute('data-mode', 'edit');
        document.getElementById('productForm').setAttribute('data-product-id', productId);

        document.getElementById('name').value = product.title || product.name;
        document.getElementById('price').value = product.price;
        document.getElementById('description').value = product.description;
        document.getElementById('category').value = product.category;
        document.getElementById('thumbnail').value = product.thumbnail || '';
        document.getElementById('is_featured').checked = product.is_featured;

        document.getElementById('crudModal').classList.remove('hidden');
        document.getElementById('name').focus();
    } catch (error) {
        console.error("Error fetching product for edit:", error);
        showToast("Error", "Could not load product details.", "error");
    }
}

function refreshProducts() {
    const filter = new URLSearchParams(window.location.search).get('filter') || 'all';
    const category = new URLSearchParams(window.location.search).get('category') || '';
    fetchProducts(filter, category);
    showToast("Info", "Product list refreshed.", "success");
}

document.getElementById('productGrid').addEventListener('click', function(e) {
    const target = e.target;

    if (target.dataset.action === 'edit') {
        showEditModal(target.dataset.productId);
    }

    if (target.dataset.action === 'delete') {
        showDeleteModal(target.dataset.productId);
    }
});

</script>

{% endblock content %}
